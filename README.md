# 关键技术点

### MySQL关系型数据库

### 单例模式

### queueSTL队列

### C++11thread、mutex、线程同步通信、unique_lock、atomic、shared_ptr、lambda表达式、生产者消费者模型

# 项目背景

为了提高MySQL数据库的访问瓶颈，除了在服务端增加想Redis这样的缓存存储热点数据外，还可以增加连接池，来提高MySQL的访问效率



### 在高并发情况下，大量的TCP握手、Server连接认证、MySQL Server关闭连接回收资源和TCP四次挥手	会消耗大量的事件 

### 增加数据库连接池就是为了减少这一部分的性能损耗



在市场上比较流行的连接池包括阿里的druid，c3p0以及apache dbcp连接池，它们对短时间内大量的数据库增删改查操作性能的提升是很明显的 但他们有一个共同的特点都是由java实现的

# 连接池功能点介绍

> #### 连接池项目包含了数据库连接所需要的ip port userid pwd 以及其他的性能参数，例如初始连接量、最大连接量、最大空闲时间、连接超时时间等，该项目是基于C++语言实现的连接池，主要也是实现了以上几个所有连接池都支持的通过基础功能

## 初始连接量

连接池会实现和MySQL Server创建initsize个connection连接，当应用发起MySQL访问时，不用再和MySQL Server建立新的连接，而是直接从连接池中取出一个可用的连接，当连接断开之后，不要去释放connection，而时把当前的connection归还到连接池中等待下一次的调用

## 最大连接量

当并发访问MySQL Server的请求增多时，连接池中的连接已经被用光，初始化的连接量不够用了，此时会根据新的请求数量去创建更多的连接给应用去使用，但是新创建的连接数量的上线并不能超过最大连接量。

请不能过无限制的创建新的连接，因为每一个连接都占用已给socket资源，一般连接池和服务器程序部署在同一台机器上，如果连接池占用socket资源过多，那么服务器就的并发量就会下降。当这些连接使用完成之后，再次归还到连接池中

## 最大空闲时间

当访问mysql的请求过多以后，会再连接池中动态增加一些连接，这些动态增加的连接使用完后会归还到连接池中，如果超过maxIdleTime仍然没有被再次使用，这些动态增加的连接资源就要被回收，连接池中保持初始连接量个数的连接

## 连接超时时间

当mysql的并发请求非常大，数据库连接池中的连接量已经到达了最大连接量，并且都被使用了，那么此时应用再次发出请求则无法从连接池中获取连接，它通过阻塞的方式获取连接的时间如果超过connectionTimeout时间，那么获取连接失败，无法访问数据库

```sql
CREATE TABLE users (
    username VARCHAR(50) NOT NULL,
    age int,
    sex VARCHAR(10) NOT NULL
);
```

# 压力测试

| 数据量 | 未使用连接池花费的数量         | 使用连接池花费的数量           |
| ------ | ------------------------------ | ------------------------------ |
| 1000   | 单线程：1891ms 四线程：497ms   | 单线程：1079ms 四线程：408ms   |
| 5000   | 单线程：10033ms 四线程：2361ms | 单线程： 5380ms 四线程：2041ms |
| 10000  | 单线程：19403ms 四线程：4589ms | 单线程：10522ms 四线程：4034ms |

# 项目功能点

## 连接池采用单例模式

## 维护一个空闲连接队列，队列的元素插入和删除，用的是生产者消费者模型

> 因为多个线程之间可能会竞争空闲连接队列

### 技术

#### mutex	=>  做线程的互斥操作

#### condition_variable  =>	做线程间的同步通信操作

### unique_lock	=>	用于管理互斥锁	防止产生死锁



## 三个线程

### produce线程

> #### 向连接池中添加连接

### 定时清理线程

> #### 每隔最大时间	对队列进行一次清理	
>
> #### 看看当前存在的连接数量是否大于最大初始连接量
>
> #### 如果大于就去做清理	看看队首连接的存活时间是否大于最大空闲时间	大于清理

这两个线程都是对内使用的线程，一般设置为后台线程 detach

而下面的consumer线程是对外使用的 一般是对服务器提供的接口 供服务器调用

### consumer线程

> #### 服务器要向访问数据库的时候访问该接口	在连接池中选一个连接	然后返回

## 消费者取出的连接用shared_ptr管理，用lambda表达式重新实现连接的释放

### 正常连接的释放时把该连接资源释放，我们重写想该连接重新放回队列中

